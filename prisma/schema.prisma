generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
  USER
}

model User {
  id               String            @id
  pubkey           String            @unique
  createdAt        DateTime          @default(now())
  nwc              String?
  cardDesigns      CardDesign[]
  ntag424s         Ntag424[]
  lightningAddress LightningAddress?
  cards            Card[]
  albySubAccount   AlbySubAccount?
  albyEnabled      Boolean           @default(false)
  role             UserRole          @default(USER)

  @@index([role])
}

model CardDesign {
  id          String   @id @default(uuid())
  imageUrl    String
  description String
  createdAt   DateTime @default(now())
  cards       Card[]
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Ntag424 {
  cid       String   @id
  k0        String
  k1        String
  k2        String
  k3        String
  k4        String
  ctr       Int
  createdAt DateTime @default(now())
  card      Card?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
}

model LightningAddress {
  username  String   @id
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Card {
  id         String    @id @default(uuid())
  designId   String
  ntag424Cid String?   @unique
  createdAt  DateTime  @default(now())
  title      String?
  lastUsedAt DateTime?
  userId     String?
  username   String?
  otc        String?

  design  CardDesign @relation(fields: [designId], references: [id])
  ntag424 Ntag424?   @relation(fields: [ntag424Cid], references: [cid])
  user    User?      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model AlbySubAccount {
  appId       Int      @id
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  username    String? // alby sub account username@getalby.com
  nwcUri      String
  nostrPubkey String? // nostr pubkey for nip57
  createdAt   DateTime @default(now())
}

model Settings {
  name String @id
  value String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}